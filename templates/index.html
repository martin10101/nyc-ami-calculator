<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NYC AMI Allocator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e1116;--card:#171b22;--muted:#8b93a7;--text:#e7eaf1;--accent:#635bff;--accent2:#1f8efa;
      --ok:#19c37d;--warn:#f5a524;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 12px}
    p.sub{color:var(--muted);margin:0 0 24px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 4px 30px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .controls{grid-column:1/-1}
    .btn{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#242a35}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#0f131a;color:var(--text)}
    .two{grid-column:span 6}
    .three{grid-column:span 4}
    .cols-6{grid-column:span 12}
    .scens{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-top:18px}
    .scen{background:#121720;border-radius:14px;padding:14px}
    .scen h3{margin:0 0 8px}
    .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
    details{background:#0f141c;border-radius:10px;padding:8px 10px;margin:6px 0}
    summary{cursor:pointer;font-weight:600}
    .tag{display:inline-block;background:#0e1420;border:1px solid #283048;color:#b9c2d2;border-radius:999px;padding:2px 8px;margin:2px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>NYC AMI Allocator</h1>
    <p class="sub">Upload your schedule (.xlsx/.xlsm/.xls/.xlsb/.csv/.docx). We’ll detect the predesignated affordable units and generate <b>six</b> compliant strategies (S1–S3 strict; R1–R3 relaxed).</p>

    <div class="grid">
      <div class="card controls">
        <div class="grid">
          <div class="cols-6 three">
            <label>File</label>
            <input id="file" type="file"/>
            <div style="font-size:12px;color:var(--muted);margin-top:6px;">We parse fuzzy headers like AIME/AMI, SQ FT/SF/NET SF.</div>
          </div>
          <div class="three">
            <label>Sheet (optional)</label>
            <input id="sheet" type="text" placeholder="Sheet1"/>
          </div>
          <div class="three">
            <label>Write mode</label>
            <select id="write">
              <option value="same">Write back to same name</option>
              <option value="new">Create new result name</option>
            </select>
          </div>
          <div class="three">
            <label>Require ≥1 family unit (2BR+) at 40%</label>
            <select id="fam"><option value="0">No</option><option value="1">Yes</option></select>
          </div>
          <div class="three">
            <label>Max 40% units per floor (optional)</label>
            <input id="spread" type="text" placeholder="e.g., 12"/>
          </div>
          <div class="three">
            <label>Exempt top K floors from 40% (optional)</label>
            <input id="exempt" type="text" placeholder="e.g., 2"/>
          </div>
          <div class="two">
            <button class="btn" id="preview">Preview scenarios</button>
          </div>
          <div class="two">
            <button class="btn secondary" id="dl">Download Excel (Master + Breakdowns)</button>
          </div>
          <div class="two">
            <button class="btn secondary" id="master">Download Master All Results</button>
          </div>
        </div>
        <div id="msg" style="margin-top:10px;color:var(--muted)"></div>
      </div>

      <div class="cols-6">
        <div id="scenarios" class="scens"></div>
      </div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);

function renderScenarios(payload){
  const container = $("#scenarios");
  container.innerHTML = "";
  const order = ["S1","S2","S3","R1","R2","R3"].filter(k => payload.scenarios[k]);
  order.forEach(k=>{
    const m = payload.scenarios[k].metrics;
    const b = payload.scenarios[k].buckets;
    const el = document.createElement("div");
    el.className = "scen";
    el.innerHTML = `
      <h3>Scenario ${k}</h3>
      <div class="meta">WAvg: <b>${m.wavg.toFixed(3)}%</b> · 40% SF: <b>${m.pct40.toFixed(3)}%</b></div>
      <div>
        ${["40","60","70","80","90","100"].map(t=>{
          const items = b[t]||[];
          return `
            <details ${items.length? "":"disabled"}>
              <summary>${t}% AMI units (${items.length})</summary>
              <div>${items.map(u=>`<span class="tag">${u.APT||""} · ${u.FLOOR??""}F · ${u.NET_SF.toFixed(0)} sf</span>`).join("")||"<span class='tag'>None</span>"}</div>
            </details>
          `;
        }).join("")}
      </div>
    `;
    container.appendChild(el);
  });
}

$("#preview").onclick = async ()=>{
  const f = $("#file").files[0];
  if(!f){ $("#msg").textContent="Pick a file first."; return; }
  const fd = new FormData();
  fd.append("file", f);
  if($("#sheet").value) fd.append("sheet", $("#sheet").value);
  fd.append("require_family_at_40", $("#fam").value);
  if($("#spread").value) fd.append("spread_40_max_per_floor", $("#spread").value);
  if($("#exempt").value) fd.append("exempt_top_k_floors", $("#exempt").value);

  $("#msg").textContent="Running…";
  const res = await fetch("/preview", { method:"POST", body:fd });
  const data = await res.json();
  if(!res.ok){ $("#msg").textContent = data.error || "Error"; return; }
  $("#msg").textContent = `Best scenario: ${data.best}`;
  renderScenarios(data);
};

$("#dl").onclick = async ()=>{
  const f = $("#file").files[0];
  if(!f){ $("#msg").textContent="Pick a file first."; return; }
  const fd = new FormData();
  fd.append("file", f);
  if($("#sheet").value) fd.append("sheet", $("#sheet").value);
  fd.append("write_back", $("#write").value);
  fd.append("require_family_at_40", $("#fam").value);
  if($("#spread").value) fd.append("spread_40_max_per_floor", $("#spread").value);
  if($("#exempt").value) fd.append("exempt_top_k_floors", $("#exempt").value);

  const res = await fetch("/allocate", { method:"POST", body:fd });
  if(!res.ok){ const d=await res.json(); $("#msg").textContent=d.error||"Error"; return; }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=f.name.replace(/\.xlsx?$/i,"") + " - AMI Scenarios.xlsx";
  a.click(); URL.revokeObjectURL(url);
};

$("#master").onclick = async ()=>{
  const res = await fetch("/export_master");
  if(!res.ok){ const d=await res.json(); $("#msg").textContent=d.error||"Error"; return; }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="AMI Master All Results.xlsx";
  a.click(); URL.revokeObjectURL(url);
};
</script>
</body>
</html>
