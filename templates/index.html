<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NYC AMI Allocator</title>
  <style>
    :root{--bg:#0f1115;--card:#161a22;--text:#e8ecf1;--muted:#a9b4c2;--accent:#6d9eff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;padding:18px;margin-bottom:16px;box-shadow:0 0 0 1px #1e2430}
    label{display:block;margin:.4rem 0 .2rem;color:var(--muted)}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #293245;background:#0e1218;color:var(--text)}
    .row{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #2b3550;background:var(--accent);color:#0b0f16;font-weight:600;cursor:pointer}
    .btn.secondary{background:#20283a;color:var(--text)}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(3,minmax(0,1fr))}
    .pill{display:inline-block;padding:6px 8px;margin:4px;border-radius:999px;background:#1e2533;border:1px solid #2b3550;color:#cfe0ff;font-size:12px}
    .title{font-size:22px;font-weight:700;margin:0 0 10px}
    .muted{color:var(--muted)}
    #spinner{display:none;margin:8px 0;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <h1 class="title">NYC AMI Allocator</h1>
  <div class="card">
    <form id="f">
      <div class="row">
        <div>
          <label>File</label>
          <input type="file" name="file" required />
        </div>
        <div>
          <label>Sheet (optional)</label>
          <input name="sheet" placeholder="Sheet1"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Require ≥1 family unit (2BR+) at 40%</label>
          <select name="require_family_at_40">
            <option value="0">No</option><option value="1">Yes</option>
          </select>
        </div>
        <div>
          <label>Max 40% units per floor (optional)</label>
          <input name="spread_40_max_per_floor" placeholder="e.g., 2"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Exempt top K floors from 40% (optional)</label>
          <input name="exempt_top_k_floors" placeholder="e.g., 2"/>
        </div>
        <div>
          <label>Return top scenarios</label>
          <select name="top_k"><option>3</option><option>2</option></select>
        </div>
      </div>
      <div style="margin-top:6px">
        <label><input type="checkbox" id="fast_preview" checked/> Fast preview (heuristic only)</label>
      </div>
      <div id="spinner">Working…</div>
      <div style="margin-top:12px">
        <button class="btn" type="button" onclick="doPreview()">Preview scenarios</button>
        <button class="btn secondary" type="button" onclick="doDownload()">Download Excel (Master + Breakdowns)</button>
        <a class="btn secondary" href="/export_master">Download Master All Results</a>
      </div>
    </form>
  </div>

  <div id="out"></div>
</div>
<script>
function setBusy(b){
  const sp = document.getElementById('spinner');
  if (sp) sp.style.display = b ? 'block' : 'none';
}
function fmt(n){ return (typeof n==='number' && isFinite(n)) ? n.toFixed(3) : '—'; }

async function doPreview(){
  setBusy(true);
  try{
    const f = document.getElementById('f');
    const fd = new FormData(f);
    // fast preview (heuristic only) checkbox -> server expects 1/0
    fd.append('fast_preview', document.getElementById('fast_preview').checked ? '1' : '0');

    const r = await fetch('/preview', { method:'POST', body: fd });
    const j = await r.json().catch(()=>({error:'Invalid JSON from server'}));
    if(!r.ok || j.error){
      alert(j.error || ('HTTP '+r.status));
      return;
    }

    // j should have: { filename, best, metrics:{S1:{wavg,pct40,...},...}, scenarios:{S1:{'40':[]...}, ...} }
    const out = document.getElementById('out');
    out.innerHTML = '';

    // header
    const hdr = document.createElement('div');
    hdr.className = 'card';
    hdr.innerHTML = `<div class="title">Preview · ${j.filename || ''}</div>
      <div class="muted">Best: <b>${j.best||'—'}</b></div>`;
    out.appendChild(hdr);

    // scenarios grid
    const grid = document.createElement('div');
    grid.className = 'grid';
    out.appendChild(grid);

    const scenarios = j.scenarios || {};
    const metrics = j.metrics || {};

    Object.keys(scenarios).forEach(k=>{
      const m = metrics[k] || {};
      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `<div class="title">Scenario ${k}</div>
        <div class="muted">
          Weighted Avg AMI: <b>${fmt(m.wavg)}%</b> ·
          40% Share (by SF): <b>${fmt(m.pct40)}%</b>
        </div>`;

      const bands = scenarios[k];
      ["40","60","70","80","90","100"].forEach(t=>{
        const arr = (bands && bands[t]) || [];
        if(!arr.length) return;
        const s = document.createElement('div'); s.style.marginTop='8px';
        s.innerHTML = `<div class="muted">▼ ${t}% AMI units (${arr.length})</div>`;
        arr.forEach(u=>{
          const p=document.createElement('span'); p.className='pill';
          const fl = (u.FLOOR==null || isNaN(u.FLOOR)) ? '' : `${u.FLOOR}F · `;
          const sf = (typeof u.NET_SF==='number') ? `${Math.round(u.NET_SF)} sf` : '';
          p.textContent = `${u.APT ?? ''} · ${fl}${sf}`;
          s.appendChild(p);
        });
        card.appendChild(s);
      });

      grid.appendChild(card);
    });

  } catch(err){
    alert('Preview error: '+ (err?.message || err));
  } finally {
    setBusy(false);
  }
}

async function doDownload(){
  setBusy(true);
  try{
    const f = document.getElementById('f');
    const fd = new FormData(f);
    const r = await fetch('/allocate', { method:'POST', body: fd });

    if(!r.ok){
      let msg='Download failed';
      try{
        const j=await r.json();
        if(j && j.error) msg=j.error;
      }catch(_){}
      alert(msg);
      return;
    }
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'AMI Scenarios.xlsx';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  } catch(err){
    alert('Download error: '+ (err?.message || err));
  } finally {
    setBusy(false);
  }
}
</script>
</body>
</html>
