<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NYC AMI Allocator — Scenarios A/B/C</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-semibold">NYC AMI Allocator</h1>
      <p class="text-slate-600 mt-1">
        Upload your schedule (.xlsx/.xlsm/.xls/.xlsb/.csv/.docx). We’ll detect the
        predesignated affordable units and generate three compliant, profit-oriented scenarios.
      </p>
    </header>

    <section class="bg-white rounded-2xl shadow p-6">
      <form id="form" class="grid gap-5" onsubmit="return false;">
        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">File</label>
            <input id="file" type="file" class="w-full rounded-lg border border-slate-300 p-2"
                   accept=".xlsx,.xlsm,.xls,.xlsb,.csv,.docx" />
            <p class="text-xs text-slate-500 mt-1">We parse fuzzy headers like AIME/AMI, SQ FT/SF/NET SF.</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Sheet (optional)</label>
            <input id="sheet" type="text" placeholder="Sheet1"
                   class="w-full rounded-lg border border-slate-300 p-2"/>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Write mode</label>
            <select id="write_back" class="w-full rounded-lg border border-slate-300 p-2">
              <option value="new">Create new result name</option>
              <option value="same">Write back to same name</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Require ≥1 family unit (2BR+) at 40%</label>
            <select id="require_family" class="w-full rounded-lg border border-slate-300 p-2">
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Max 40% units per floor (optional)</label>
            <input id="cap_per_floor" type="number" min="1" placeholder="e.g., 2"
                   class="w-full rounded-lg border border-slate-300 p-2"/>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Exempt top K floors from 40% (optional)</label>
            <input id="exempt_top" type="number" min="0" placeholder="e.g., 2"
                   class="w-full rounded-lg border border-slate-300 p-2"/>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          <button id="btnPreview" class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">
            Preview scenarios
          </button>
          <button id="btnDownload" class="px-5 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100">
            Download Excel (Master + Breakdowns)
          </button>
          <a href="/export_master" class="px-5 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100">
            Download Master All Results
          </a>
          <span id="status" class="text-sm text-slate-500"></span>
        </div>
      </form>
    </section>

    <section id="previewArea" class="mt-8 grid md:grid-cols-3 gap-4"></section>
  </div>

  <script>
    const fileEl = document.getElementById('file');
    const sheetEl = document.getElementById('sheet');
    const writeBackEl = document.getElementById('write_back');
    const familyEl = document.getElementById('require_family');
    const capFloorEl = document.getElementById('cap_per_floor');
    const exemptTopEl = document.getElementById('exempt_top');
    const statusEl = document.getElementById('status');
    const previewArea = document.getElementById('previewArea');

    function mkFormData(preview=false) {
      const fd = new FormData();
      if (!fileEl.files.length) { alert("Please choose a file."); throw new Error(); }
      fd.append("file", fileEl.files[0]);
      if (sheetEl.value) fd.append("sheet", sheetEl.value);
      fd.append("require_family_at_40", familyEl.value);
      if (capFloorEl.value) fd.append("spread_40_max_per_floor", capFloorEl.value);
      fd.append("exempt_top_k_floors", exemptTopEl.value || 0);
      if (!preview) fd.append("write_back", writeBackEl.value);
      return fd;
    }

    function scenarioCard(label, metrics, buckets) {
      const card = document.createElement('div');
      card.className = "bg-white rounded-2xl shadow p-4";
      const m = metrics[label];
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Scenario ${label}</h3>
          <div class="text-sm text-slate-500">
            WAvg: <span class="font-medium">${m.wavg.toFixed(3)}%</span> ·
            40% SF: <span class="font-medium">${m.pct40.toFixed(3)}%</span>
          </div>
        </div>
        <p class="text-sm text-slate-600 mt-1">Compliant, profit-oriented variant.</p>
      `;
      const groups = [
        ["40","40% AMI units"],["60","60% AMI units"],["70","70% AMI units"],
        ["80","80% AMI units"],["90","90% AMI units"],["100","100% AMI units"],
      ];
      groups.forEach(([key,title])=>{
        const arr = buckets[key] || [];
        const details = document.createElement('details');
        details.className = "mt-3 rounded-xl border border-slate-200";
        const summary = document.createElement('summary');
        summary.className = "cursor-pointer select-none px-3 py-2 bg-slate-50 rounded-t-xl";
        summary.innerHTML = `${title} <span class="text-slate-500">(${arr.length})</span>`;
        const body = document.createElement('div');
        body.className = "max-h-56 overflow-auto text-sm p-3";
        body.innerHTML = arr.length
          ? `<table class="w-full text-left">
               <thead class="text-slate-500">
                 <tr><th class="pr-2">APT</th><th class="pr-2">Fl</th><th class="pr-2">Bed</th><th class="pr-2">SF</th></tr>
               </thead>
               <tbody>${arr.map(r=>`<tr>
                 <td class="pr-2">${r.APT ?? ""}</td>
                 <td class="pr-2">${r.FLOOR ?? ""}</td>
                 <td class="pr-2">${r.BED ?? ""}</td>
                 <td class="pr-2">${r.NET_SF.toLocaleString()}</td>
               </tr>`).join("")}</tbody>
             </table>`
          : `<div class="text-slate-500">None</div>`;
        details.appendChild(summary); details.appendChild(body);
        card.appendChild(details);
      });
      return card;
    }

    document.getElementById('btnPreview').onclick = async () => {
      statusEl.textContent = "Generating preview…";
      previewArea.innerHTML = "";
      try {
        const fd = mkFormData(true);
        const res = await fetch('/preview', { method: 'POST', body: fd });
        const js = await res.json();
        if (!res.ok) throw new Error(js.error || "Preview failed");
        statusEl.textContent = "";
        previewArea.appendChild(scenarioCard("A", js.metrics, js.A));
        previewArea.appendChild(scenarioCard("B", js.metrics, js.B));
        previewArea.appendChild(scenarioCard("C", js.metrics, js.C));
      } catch (e) {
        statusEl.textContent = e.message;
      }
    };

    document.getElementById('btnDownload').onclick = async () => {
      statusEl.textContent = "Building Excel…";
      try {
        const fd = mkFormData(false);
        const res = await fetch('/allocate', { method: 'POST', body: fd });
        if (!res.ok) {
          const js = await res.json().catch(()=>({}));
          throw new Error(js.error || "Allocate failed");
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const fnameHdr = res.headers.get("Content-Disposition") || '';
        const match = fnameHdr.match(/filename="(.+?)"/);
        a.download = match ? match[1] : 'AMI Scenarios.xlsx';
        a.href = url; a.click();
        URL.revokeObjectURL(url);
        statusEl.textContent = "Downloaded.";
      } catch (e) {
        statusEl.textContent = e.message;
      }
    };
  </script>
</body>
</html>
